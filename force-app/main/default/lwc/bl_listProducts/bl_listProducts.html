<template>
    <!--DATATABLE START-->
    <!-- sldsValidatorIgnoreNextLine -->
    <lightning-spinner if:false={showLookupList} alternative-text="Loading" size="medium"></lightning-spinner>
    <template if:true={showLookupList}>
        <lightning-layout multiple-rows="false">
            <lightning-datatable key-field="Id" data={listToDisplay} columns={gridColumns}  hide-checkbox-column="true"  
            onrowaction={callRowAction} ></lightning-datatable>
            <lightning-datatable key-field="Id" class="slds-var-m-left_xxx-small" data={listToDisplayAdd} columns={gridColumnsAdd}  hide-checkbox-column="true"  
            onrowaction={callRowAction} ></lightning-datatable>
        </lightning-layout>
    </template>
    <!--DATATABLE END-->
    <!--FILTERED ADD POP-UP START-->
    <template if:true={openFilterPopup}>
        <section aria-modal="true" class="slds-modal slds-fade-in-open slds-align_absolute-center">
            <div class="slds-modal__container slds-var-m-left_medium slds-var-m-right_medium">
                <header class="slds-modal__header slds-var-m-left_medium slds-var-m-right_medium">
                    <h2 class="slds-text-heading_medium slds-hyphenate">Filter & Select: {trackList.lookupCode}</h2>
                    <lightning-icon class="slds-modal__close" icon-name="utility:close" size="small" onclick={closeFilterAndSelected}></lightning-icon>
                </header>
                <div class="slds-modal__content slds-var-m-left_medium slds-var-m-right_medium">
                    <div class="slds-var-p-around_small slds-var-m-left_medium slds-var-m-right_medium">
                        <lightning-tabset active-tab-value={activeFilterTab} class="slds-var-m-left_large slds-var-m-right_large">
                            <!--FILTER TAB START-->
                            <lightning-tab label="Filter" value="Filter" onactive={handleFilterTabActive}>
                                <!--FILTERS REQUIRED START-->
                                <div class="slds-grid slds-gutters slds-var-m-bottom_small slds-var-m-left_medium slds-var-m-right_medium">
                                    <template if:true={productTypeShow}>
                                        <lightning-layout multiple-rows="false">
                                            <template for:each={productType} for:item="productType1">
                                                <lightning-combobox class="slds-var-m-right_xx-small" label={productType1.label} key={productType1.label} 
                                                options={productType1.options} onchange={handleProductTypeChange}></lightning-combobox>
                                            </template>
                                        </lightning-layout>
                                    </template>                                
                                </div>
                                <!--FILTERS REQUIRED END-->
                                <!--FILTERS DEPENDENCIES START-->
                                <div class="slds-grid slds-gutters slds-var-m-bottom_small slds-var-m-left_medium slds-var-m-right_medium">
                                    <lightning-spinner if:false={filtersLoading} alternative-text="Loading" size="small"></lightning-spinner>
                                    <template if:true={filtersLoading}>
                                        <lightning-layout multiple-rows="false">
                                            <template for:each={listFilters} for:item="comboboxFilters">
                                                <lightning-combobox class="slds-var-m-right_x-small" key={comboboxFilters.label} label={comboboxFilters.label} value={comboboxFilters.value}
                                                options={comboboxFilters.options} onchange={handleInputChange}></lightning-combobox>
                                            </template>
                                            <template for:each={listTextFilters} for:item="textFilters">
                                                <lightning-input class="slds-var-m-right_x-small" key={textFilters.label} name={textFilters.label} type="text" label={textFilters.label} 
                                                onchange={handleInputChange}></lightning-input>
                                            </template>
                                        </lightning-layout>
                                    </template>
                                </div>
                                <!--FILTERS DEPENDENCIES END-->
                                <!--CLEAR FILTERS START-->
                                <div class="slds-grid slds-gutters slds-var-m-left_medium slds-align_absolute-center slds-var-m-right_medium">
                                    <lightning-button variant="brand" label="Clear Filters" title="Clear"  onclick={clearFilters} class="slds-var-m-left_small slds-var-m-top_large"></lightning-button>
                                </div>
                                <!--CLEAR FILTERS END-->
                                <!--RECORDS FILTERED START-->
                                <div class="slds-grid slds-gutters slds-var-m-left_medium slds-var-m-right_medium slds-var-m-top_medium">
                                    <lightning-icon icon-name="standard:filter" alternative-text="filter" size="small" class=" slds-var-m-right_small"></lightning-icon>
                                    <p style="color: rgb(21, 35, 233); font-size:16px;">Filtered, {recordsAmount} records found.</p>
                                </div>
                                <!--RECORDS FILTERED END-->
                                <div>
                                    <lightning-spinner if:true={loadingFilteData} alternative-text="Loading" size="medium"></lightning-spinner>
                                    <!--PAGINATION CONTROL START-->
                                    <div>
                                        <p class="slds-align_absolute-center"><b> Page {page} of {totalPage}</b></p>
                                        <lightning-button-group class="slds-align_absolute-center">
                                            <lightning-button label="First" icon-name="utility:chevronleft" onclick={firstHandler} class="stretchButton"></lightning-button>
                                            <lightning-button label="Previous" icon-name="utility:chevronleft" onclick={previousHandler} class="stretchButton"></lightning-button>
                                            <lightning-button label="Next" icon-name="utility:chevronright" icon-position="right" onclick={nextHandler} class="stretchButton"></lightning-button>
                                            <lightning-button label="Last" icon-name="utility:chevronright" icon-position="right" onclick={lastHandler} class="stretchButton"></lightning-button>
                                        </lightning-button-group>
                                    </div>
                                    <!--PAGINATION CONTROL END-->
                                    <!--TABLE START-->
                                    <template if:true={filtersLoading}>
                                        <lightning-datatable key-field="Id" data={dataPages} columns={columnsFilters} onrowselection={handleRowSelection}>
                                        </lightning-datatable>
                                    </template>
                                    <!--TABLE END-->
                                </div>
                            </lightning-tab>
                            <!--FILTER TAB END-->
                            <!--REVIEW TAB START-->
                            <lightning-tab label="Review" value="Review" onactive={handleReviewTabActive}>
                                <!--FILTER REQUIRED START-->
                                <template if:true={productTypeShow}>
                                    <div class="slds-grid slds-gutters slds-var-m-left_small">
                                    <lightning-layout multiple-rows="false">
                                        <template for:each={columnsRequiredReview} for:item="required">
                                            <lightning-combobox class="slds-var-m-right_xx-small" label={required.label} key={required.label} 
                                            options={required.options} onchange={handleInputChangeSelected}></lightning-combobox>
                                        </template>
                                    </lightning-layout>
                                    </div>
                                </template>  
                                <!--FILTER REQUIRED END-->
                                <template if:true={filtersLoading}>
                                    <div class="slds-grid slds-gutters slds-var-m-left_small slds-align_absolute-center">
                                    <!--FILTER DEPENDENCIES START-->
                                    <lightning-layout multiple-rows="false" >
                                        <template for:each={listFiltersReview} for:item="comboboxFilters">
                                            <lightning-combobox class="slds-var-m-right_xx-small" key={comboboxFilters.label} label={comboboxFilters.label} value={comboboxFilters.value}
                                            options={comboboxFilters.options} onchange={handleInputChangeSelected}></lightning-combobox>
                                        </template>
                                        <template for:each={listTextFilters} for:item="textFilters">
                                            <lightning-input class="slds-var-m-right_xx-small" key={textFilters.label} name={textFilters.label} type="text" label={textFilters.label} 
                                            onchange={handleInputChangeSelected}></lightning-input>
                                        </template>
                                    </lightning-layout>
                                    <!--FILTER DEPENDENCIES END-->
                                    <!--CLEAR FILTER START-->
                                    </div>
                                    <div class="slds-grid slds-gutters slds-var-m-left_large slds-align_absolute-center slds-var-m-right_small">
                                        <lightning-button variant="brand" label="Clear Filters" title="Clear"  onclick={clearFilters} class="slds-var-m-left_small slds-var-m-top_large"></lightning-button>
                                    </div>
                                    <!--CLEAR FILTER END-->
                                    <!--RECORDS SELECTED START-->
                                    <div class="slds-grid slds-gutters slds-var-m-left_large slds-var-m-top_medium">
                                        <lightning-icon icon-name="standard:filter" alternative-text="filter" size="small" class=" slds-var-m-right_small"></lightning-icon>
                                        <p style="color: rgb(21, 35, 233); font-size:16px;">Reviewing, {reviewDisplay.length} records.</p>
                                    </div>
                                    <!--RECORDS INFORMATION END-->
                                    <div>
                                        <!--PAGINATION CONTROL START-->
                                        <div>
                                            <p class="slds-align_absolute-center"><b> Page {pageR} of {totalPageR}</b></p>
                                            <lightning-button-group class="slds-align_absolute-center">
                                                <lightning-button label="First" icon-name="utility:chevronleft" onclick={firstHandlerR} class="stretchButton"></lightning-button>
                                                <lightning-button label="Previous" icon-name="utility:chevronleft" onclick={previousHandlerR} class="stretchButton"></lightning-button>
                                                <lightning-button label="Next" icon-name="utility:chevronright" icon-position="right" onclick={nextHandlerR} class="stretchButton"></lightning-button>
                                                <lightning-button label="Last" icon-name="utility:chevronright" icon-position="right" onclick={lastHandlerR} class="stretchButton"></lightning-button>
                                            </lightning-button-group>
                                        </div>
                                        <!--PAGINATION CONTROL END-->
                                        <lightning-spinner if:true={reviewLoading} alternative-text="Loading" size="small"></lightning-spinner>
                                        <!--RECORDS SELECTED TABLE START-->
                                        <template if:false={reviewLoading}>
                                            <lightning-datatable key-field="Id" data={dataPagesR} columns={columnsReview} hide-checkbox-column=true onrowaction={handleRowAction}
                                            draft-values={draftValues} >
                                            </lightning-datatable>
                                        </template>
                                        <!--RECORDS SELECTED TABLE END-->
                                    </div>
                                </template>
                            </lightning-tab>
                            <!--REVIEW TAB END-->
                        </lightning-tabset>
                    </div>
                </div>
                <footer class="slds-modal__footer slds-var-m-left_medium slds-var-m-right_medium">
                    <template if:false={tabOption}>
                        <lightning-button variant="brand" label="Cancel" title="Close"  onclick={closeFilterAndSelected} class="slds-var-m-right_small"></lightning-button>   
                        <lightning-button variant="brand" label="Add" title="Add"  onclick={addProducts} class="slds-var-m-right_small"></lightning-button>    
                        <lightning-button class="slds-var-m-top_xx-small" variant="brand" label="Add & Review" title="Add & Review"  onclick={reviewProducts} disabled={goReview}></lightning-button>    

                    </template>
                    <template if:true={tabOption}>
                        <lightning-button variant="brand" label="Add More" title="AddMore"  onclick={moreAdd} class="slds-var-m-right_small"></lightning-button>   
                        <lightning-button variant="brand" label="Save & Exit" title="SaveExit"  onclick={saveLookingNSP} ></lightning-button>
                    </template>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
    <!--FILTERED ADD POP-UP END-->
    <!--NSP POP-UP START-->
    <template if:true={popupNSP}>
        <section aria-modal="true" class="slds-modal slds-fade-in-open slds-align_absolute-center" style="background-color: rgba(28, 91, 199, 0.404)">
            <div class="slds-modal__container slds-var-m-left_medium  slds-var-m-right_medium">
                <header class="slds-modal__header slds-var-m-left_medium slds-var-m-right_medium">
                    <h2 class="slds-text-heading_medium slds-hyphenate">Action Required! Populate NSP Fields</h2>
                    <lightning-icon class="slds-modal__close" icon-name="utility:close" size="small" onclick={closeNSP}></lightning-icon>
                </header>
                <div class="slds-modal__content  slds-var-m-left_medium slds-var-m-right_medium slds-var-m-right_medium">
                    <div class="slds-var-m-left_medium slds-var-m-top_small">                    
                    <lightning-icon icon-name="standard:choice" alternative-text="ProductList" title="ProductList"></lightning-icon>
                    <h1 class="slds-var-m-left_xx-small slds-form-element__label" >Products: </h1>
                    <lightning-tabset active-tab-value={firstNSP}>
                        <template for:each={listNSP} for:item="nspP">
                            <!--onclick={handleNSPTab} in tab under -->
                            <lightning-tab icon-name={nspP.iconName} class="slds-has-success slds-var-m-left_medium slds-var-m-right_medium" onactive={handleNSPTab} key={nspP.Id}  label={nspP.tabNsp} value={nspP.tabNsp}>
                                <div style="background-color:#fab8ce;" class="slds-align_absolute-center slds-var-p-around_xx-small lgc-bg">
                                    <p style="font-size:16px;"><b>Product:</b> {nspP.Name} - <b>Product Type:</b> {nspP.Product_Type__c}</p>
                                </div>
                                <lightning-spinner if:false={gettingNspFields} alternative-text="Loading" size="medium"></lightning-spinner>
                                <template if:true={gettingNspFields}>
                                    <lightning-layout multiple-rows="false">
                                    <template for:each={listNspValuesToDisplay} for:item="nspValue">
                                        <div style="background-color:#a1d5f8c2;" class="slds-var-p-around_xx-small lgc-bg" key={nspValue.label}>
                                           <p  class="slds-var-m-right_x-small" key={nspValue.label}><b>{nspValue.property}:</b> {nspValue.value}</p>
                                        </div>
                                    </template>
                                    </lightning-layout>
                                    <lightning-layout multiple-rows="false">
                                    <template for:each={nspDisplayOnly} for:item="nspDisplay">
                                        <div style="background-color:#a1d5f8c2;" key={nspDisplay.label} class="slds-var-p-around_xx-small lgc-bg">
                                          <p  class="slds-var-m-right_x-small" key={nspDisplay.label}><b>{nspDisplay.label}:</b> {nspDisplay.value}</p>
                                        </div>
                                    </template>
                                    </lightning-layout>
                                    <lightning-layout multiple-rows="false">
                                    <template for:each={nspPicklist} for:item="nspPicklistItem">
                                        <div key={nspPicklistItem.label}>
                                            <lightning-combobox class="slds-var-m-right_x-small" key={nspPicklistItem.label} label={nspPicklistItem.label} 
                                            options={nspPicklistItem.options} name={nspPicklistItem.apiName} onchange={nspPicklistChange} 
                                            value={nspPicklistItem.value}></lightning-combobox>
                                        </div>
                                    </template>
                                    </lightning-layout>
                                    <lightning-layout multiple-rows="false">
                                    <template for:each={nspNumbers} for:item="nspNumberItem">
                                        <div key={nspNumberItem.label}>
                                            <lightning-input class="slds-var-m-right_x-small" key={nspNumberItem.label} type="number" name={nspNumberItem.apiName} label={nspNumberItem.label}
                                            onchange={nspPicklistChange}></lightning-input>
                                        </div>
                                    </template>
                                    </lightning-layout>
                                </template>
                            </lightning-tab>
                        </template>
                    </lightning-tabset>
                    </div>
                    <div style="background-color:#f1ce30;" class="slds-var-p-around_xx-small slds-align_absolute-center lgc-bg">
                        <p><b>WARNING:</b>  Remember to select all the values of the Non-Standard Product (NSP) before closing the window.</p>
                    </div>
                </div>
                <footer class="slds-modal__footer slds-var-m-left_medium  slds-var-m-right_medium">
                    <lightning-button variant="brand" label="Done" title="Close"  onclick={closeNSP} ></lightning-button>    
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
    <!--NSP POP-UP END-->
    <!--FILTERED EDIT POP-UP START-->
    <template if:true={editFiltered}>
        <section aria-modal="true" class="slds-modal slds-fade-in-open slds-align_absolute-center" style="background-color: rgba(28, 91, 199, 0.404)">
            <div class="slds-modal__container slds-var-m-left_medium  slds-var-m-right_medium">
                <header class="slds-modal__header slds-var-m-left_medium slds-var-m-right_medium">
                    <h2 class="slds-text-heading_medium slds-hyphenate">Edit filtered products from: {editLookupCodeRow.lookupCode}</h2>
                    <lightning-icon class="slds-modal__close" icon-name="utility:close" size="small" onclick={closeEditFiltered}></lightning-icon>
                </header>
                <div class="slds-modal__content  slds-var-m-left_medium slds-var-m-right_medium">
                    <div class="slds-var-m-left_small slds-var-m-right_small slds-var-m-top_small">
                        <!--PAGINATION CONTROL START-->
                        <div>
                            <p class="slds-align_absolute-center"><b> Quote lines: {editQuoteLines.length}</b></p>
                            <p class="slds-align_absolute-center"><b> Page {pageEdit} of {totalPageEdit}</b></p>
                            <lightning-button-group class="slds-align_absolute-center">
                                <lightning-button label="First" icon-name="utility:chevronleft" onclick={firstHandlerEdit} class="stretchButton"></lightning-button>
                                <lightning-button label="Previous" icon-name="utility:chevronleft" onclick={previousHandlerEdit} class="stretchButton"></lightning-button>
                                <lightning-button label="Next" icon-name="utility:chevronright" icon-position="right" onclick={nextHandlerEdit} class="stretchButton"></lightning-button>
                                <lightning-button label="Last" icon-name="utility:chevronright" icon-position="right" onclick={lastHandlerEdit} class="stretchButton"></lightning-button>
                            </lightning-button-group>
                        </div>
                        <!--PAGINATION CONTROL END-->
                        <!--DATATABLE START-->
                        <div class="slds-align_absolute-center slds-var-m-top_small">
                            <lightning-spinner if:true={editLoading} alternative-text="Loading" size="medium"></lightning-spinner>
                            <template if:false={editLoading}>
                                <lightning-datatable style="width:100%;" key-field="id" draft-values={draftValuesQuote} data={dataPagesEdit} columns={columnsEdit} 
                                onrowaction={handleDeleteEdit} onsave={handleSaveEditionEdit} hide-checkbox-column 
                                ></lightning-datatable>
                            </template>
                            
                        </div>
                        <!--DATATABLE END-->
                    </div>
                </div>
                <footer class="slds-modal__footer slds-var-m-left_medium  slds-var-m-right_medium">
                    <lightning-button variant="brand" label="Close" title="Close"  onclick={closeEditFiltered} ></lightning-button>    
                    <lightning-button variant="brand" label="Save" title="Save"  onclick={saveEditPopUp} class="slds-var-m-left_small"></lightning-button>    
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
    <!--FILTERED EDIT POP-UP END-->
    <!--CONFIGURED POP-UP START-->
        <!--NO CONFIGURED HERE-->
    <!--CONFIGURED POP-UP END-->
</template>